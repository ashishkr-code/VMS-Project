<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Auditor Dashboard - CVE Review</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

    <style>
        :root {
            --sidebar-width: 260px;
            --accent: #007bff;
        }

        body {
            background: #f5f7fa;
            font-family: "Segoe UI", sans-serif;
            transition: background-color .3s, color .3s;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        body.dark {
            background: #0f1720;
            color: #e6eef6;
        }

        header {
            background: #1e2a38;
            color: white;
            padding: 0.75rem 1.5rem; /* Increased padding */
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1020;
        }

        .hamburger {
            background: none;
            border: none;
            color: white;
            font-size: 1.6rem;
            margin-right: 0.5rem;
        }

        .toggle-dark {
            background: var(--accent);
            border: none;
            border-radius: 8px;
            padding: 6px 10px;
            color: white;
            font-size: 1rem;
        }

        .sidebar-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.45);
            z-index: 1050;
            display: none;
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: var(--sidebar-width);
            background: #1e2a38;
            color: white;
            transform: translateX(-100%);
            transition: transform .3s;
            z-index: 1060;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            box-shadow: 6px 0 15px rgba(0, 0, 0, 0.1);
        }

        .sidebar.open {
            transform: translateX(0);
        }

        .nav-link {
            color: rgba(255, 255, 255, 0.8); /* Softer link color */
            display: flex;
            align-items: center;
            gap: .75rem; /* Increased gap */
            padding: .6rem .8rem;
            border-radius: 8px;
            margin-bottom: .3rem;
            text-decoration: none;
            transition: background-color .2s, color .2s;
        }

        .nav-link.active,
        .nav-link:hover {
            background: var(--accent);
            color: white;
        }

        .content {
            transition: margin-left .3s;
            padding: 1.5rem;
        }

        .card {
            border-radius: 12px; /* Softer radius */
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.05);
            background: white;
            padding: 1.5rem;
            border: none; /* Cleaner look */
            height: 100%; /* For grid layout */
        }

        body.dark .card {
            background: #1e2a38; /* Darker card */
            color: white;
            box-shadow: none;
        }

        .table {
            margin-top: 1rem;
            vertical-align: middle;
        }

        .table td {
            white-space: normal !important;
            word-wrap: break-word;
        }

        /* Dark mode table styles */
        body.dark .table {
            color: #e6eef6;
        }

        body.dark .table-hover > tbody > tr:hover > * {
           background-color: rgba(255, 255, 255, 0.07);
        }

        body.dark .table-dark {
            background-color: #343a40;
            border-color: #454d55;
        }

        body.dark .form-control,
        body.dark .form-select {
            background-color: #2c3e50;
            color: white;
            border-color: #454d55;
        }

        body.dark .form-control:focus,
        body.dark .form-select:focus {
            background-color: #2c3e50;
            color: white;
            border-color: var(--accent);
            box-shadow: 0 0 0 .25rem rgba(0, 123, 255, .25);
        }

        body.dark .form-control::placeholder {
            color: #aaa;
        }


        .d-none {
            display: none !important;
        }

        .filter-bar .form-label {
            font-size: .875rem;
            font-weight: 600;
            margin-bottom: .25rem;
        }
    </style>
</head>

<body th:class="${session.theme == 'dark' ? 'dark' : ''}">

<div id="sidebarOverlay" class="sidebar-overlay" onclick="closeSidebar()"></div>
<aside id="sidebar" class="sidebar">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h4 class="mb-0">CVE Auditor</h4>
            <small class="text-light">Auditor Panel</small>
        </div>
        <button class="btn btn-sm btn-outline-light d-lg-none" onclick="closeSidebar()">&times;</button>
    </div>

    <nav>
        <a class="nav-link active" id="side-dashboard" href="#" onclick="showSection('dashboard')"><i class="bi bi-speedometer2"></i> Dashboard</a>
        <a class="nav-link" id="side-cve" href="#" onclick="showSection('cve')"><i class="bi bi-bug-fill"></i> CVEs</a>
        <a class="nav-link" id="side-product" href="#" onclick="showSection('product')"><i class="bi bi-box-seam"></i> Products</a>
        <a class="nav-link" id="side-profile" href="#" onclick="showSection('profile')"><i class="bi bi-person-circle"></i> Profile</a>
        <a class="nav-link text-danger" th:href="@{/logout}"><i class="bi bi-box-arrow-right"></i> Logout</a>
    </nav>

    <div style="margin-top:auto; font-size:.85rem; color:rgba(255,255,255,0.7);">
        <hr>
        Logged in as <strong th:text="${auditorName ?: 'Auditor'}">Auditor</strong><br>
        <small>VMS â€¢ v1.2</small>
    </div>
</aside>

<header>
    <div class="d-flex align-items-center gap-2">
        <button class="hamburger" onclick="openSidebar()" aria-label="Toggle Navigation"><i class="bi bi-list"></i></button>
        <div>
            <h2 class="h4 mb-0" style="line-height: 1;">Auditor Dashboard</h2>
            <small style="color:rgba(255,255,255,0.8)">Vulnerability Review</small>
        </div>
    </div>
    <button class="toggle-dark" onclick="toggleDarkMode()" aria-label="Toggle Dark Mode"><span id="themeIcon">ðŸŒ™</span></button>
</header>

<main class="content container-fluid px-4 py-4">

    <div id="dashboardSection">
        <div class="card shadow-sm mb-4">
            <div class="card-body text-center">
                <h5 class="card-title">System Overview</h5>
                <div class="row mt-3">
                    <div class="col-md-4">
                        <h5><span th:text="${totalCves}">0</span></h5>
                        <small class="text-muted">Total CVEs</small>
                    </div>
                    <div class="col-md-4">
                        <h5><span th:text="${activeCves}">0</span></h5>
                        <small class="text-muted">Active CVEs</small>
                    </div>
                    <div class="col-md-4">
                        <h5><span th:text="${totalProducts}">0</span></h5>
                        <small class="text-muted">Total Products</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4"> <div class="col-lg-4 col-md-6">
            <div class="card">
                <h6 class="card-title mb-3">Severity Distribution</h6>
                <canvas id="severityChart"
                        th:data-labels="${severityLabels}"
                        th:data-values="${severityValues}">
                </canvas>
            </div>
        </div>
            <div class="col-lg-4 col-md-6">
                <div class="card">
                    <h6 class="card-title mb-3">Status Distribution</h6>
                    <canvas id="statusChart"
                            th:data-labels="${statusLabels}"
                            th:data-values="${statusValues}">
                    </canvas>
                </div>
            </div>
            <div class="col-lg-4 col-md-12">
                <div class="card">
                    <h6 class="card-title mb-3">Product-wise CVE Count</h6>
                    <canvas id="productChart"
                            th:data-labels="${productCveLabels}"
                            th:data-values="${productCveValues}">
                    </canvas>
                </div>
            </div>
        </div>
    </div>

    <div id="cveSection" class="d-none">
        <div class="card">
            <h5 class="card-title">Reviewed CVEs</h5>

            <div class="filter-bar mb-3">
                <form class="row g-2 align-items-end" onsubmit="event.preventDefault(); filterCves();">
                    <div class="col-lg-3 col-md-6">
                        <label for="searchCveInput" class="form-label">Search</label>
                        <input type="text" id="searchCveInput" class="form-control" placeholder="CVE ID, package, description..." aria-label="Search CVEs">
                    </div>
                    <div class="col-lg-2 col-md-6">
                        <label for="severityFilter" class="form-label">Severity</label>
                        <select id="severityFilter" class="form-select" aria-label="Filter by Severity">
                            <option value="">All Severities</option>
                            <option>LOW</option><option>MEDIUM</option><option>HIGH</option><option>CRITICAL</option>
                        </select>
                    </div>
                    <div class="col-lg-2 col-md-6">
                        <label for="statusFilter" class="form-label">Status</label>
                        <select id="statusFilter" class="form-select" aria-label="Filter by Status">
                            <option value="">All Status</option>
                            <option>ACTIVE</option><option>INACTIVE</option>
                        </select>
                    </div>
                    <div class="col-lg-2 col-md-3">
                        <label for="fromDate" class="form-label">From</label>
                        <input type="date" id="fromDate" class="form-control" aria-label="From Date">
                    </div>
                    <div class="col-lg-2 col-md-3">
                        <label for="toDate" class="form-label">To</label>
                        <input type="date" id="toDate" class="form-control" aria-label="To Date">
                    </div>
                    <div class="col-lg-auto col-md-6">
                        <button type="submit" class="btn btn-primary w-100">Filter</button>
                    </div>
                    <div class="col-lg-auto col-md-6">
                        <button type="button" class="btn btn-secondary w-100" onclick="resetCveFilters()">Reset</button>
                    </div>
                </form>
            </div>

            <div class="table-responsive">
                <table class="table table-hover align-middle" id="cveTable">
                    <thead class="table-dark">
                    <tr>
                        <th>CVE ID</th>
                        <th>Package</th>
                        <th>Description</th>
                        <th>Severity</th>
                        <th>Status</th>
                        <th>Version Start</th>
                        <th>Version End</th>
                        <th>Product</th>
                        <th>Reviewed On</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="cve : ${cveList}">
                        <td th:text="${cve.cveId}">CVE-XXX</td>
                        <td th:text="${cve.packageName}">pkg</td>
                        <td th:text="${cve.description}">Desc</td>
                        <td>
                            <span th:text="${cve.severity}"
                                  th:classappend="${cve.severity.name() == 'LOW' ? 'badge bg-success' :
                                                   (cve.severity.name() == 'MEDIUM' ? 'badge bg-warning text-dark' :
                                                   (cve.severity.name() == 'HIGH' ? 'badge bg-danger' :
                                                   (cve.severity.name() == 'CRITICAL' ? 'badge bg-dark' : 'badge bg-secondary')))}">
                                MEDIUM
                            </span>
                        </td>
                        <td>
                            <span th:text="${cve.status}"
                                  th:classappend="${cve.status.name() == 'ACTIVE' ? 'badge bg-success' : 'badge bg-danger'}">
                                ACTIVE
                            </span>
                        </td>
                        <td th:text="${cve.version != null ? cve.version.versionstart : 'N/A'}">5.0.0</td>
                        <td th:text="${cve.version != null ? cve.version.versionend : 'N/A'}">5.3.8</td>

                        <td th:text="${cve.product != null ? cve.product.productId : 'N/A'}">PRD-001</td>
                        <td th:text="${#temporals.format(cve.createdAt,'yyyy-MM-dd')}">2025-10-09</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="productSection" class="d-none">
        <div class="card">
            <h5 class="card-title">Audited Products</h5>

            <div class="filter-bar mb-3">
                <form class="row g-2 align-items-end" onsubmit="event.preventDefault(); filterProducts();">
                    <div class="col-lg-4 col-md-6">
                        <label for="searchProductInput" class="form-label">Search</label>
                        <input type="text" id="searchProductInput" class="form-control" placeholder="Search Product or ID..." aria-label="Search Products">
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <label for="productStatusFilter" class="form-label">Status</label>
                        <select id="productStatusFilter" class="form-select" aria-label="Filter Product Status">
                            <option value="">All Status</option>
                            <option>PUBLISH</option><option>UNPUBLISH</option>
                        </select>
                    </div>
                    <div class="col-lg-auto col-md-6">
                        <button type="submit" class="btn btn-primary w-100">Filter</button>
                    </div>
                    <div class="col-lg-auto col-md-6">
                        <button type="button" class="btn btn-secondary w-100" onclick="resetProductFilters()">Reset</button>
                    </div>
                </form>
            </div>

            <div class="table-responsive">
                <table class="table table-hover align-middle" id="productTable">
                    <thead class="table-dark"><tr><th>ID</th><th>Name</th><th>Model</th><th>Status</th><th>Published</th></tr></thead>
                    <tbody>
                    <tr th:each="p : ${productList}">
                        <td th:text="${p.productId}">PRD-001</td>
                        <td th:text="${p.name}">Product</td>
                        <td th:text="${p.modelno}">M-001</td>
                        <td>
                             <span th:text="${p.status}"
                                   th:classappend="${p.status.name() == 'PUBLISH' ? 'badge bg-success' : 'badge bg-secondary'}">
                                PUBLISH
                            </span>
                        </td>
                        <td th:text="${#temporals.format(p.publishAt, 'yyyy-MM-dd')}">2025-01-01</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="profileSection" class="d-none">
        <div class="row justify-content-center">
            <div class="col-lg-8 col-md-10">
                <div class="card">
                    <h4 class="card-title">My Profile</h4>
                    <form th:action="@{/auditor/update-profile}" method="post" class="mt-3">
                        <div class="mb-3">
                            <label class="form-label">Name</label>
                            <input type="text" class="form-control" th:value="${auditorName}" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" th:value="${auditorEmail}" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Role</label>
                            <input type="text" class="form-control" th:value="${auditorRole}" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Joined On</label>
                            <input type="text" class="form-control" th:value="${#temporals.format(auditorCreatedAt, 'yyyy-MM-dd')}" readonly>
                        </div>
                        <hr class="my-4">
                        <div class="mb-3">
                            <label for="phoneInput" class="form-label">Phone Number</label>
                            <input type="text" name="phone" id="phoneInput" class="form-control" th:value="${auditorPhone}" placeholder="Add your phone number">
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <button type="submit" class="btn btn-primary px-4">Save Changes</button>
                            <button type="button" class="btn btn-outline-warning" onclick="alert('Role update requests must be submitted to your administrator.')">Request Role Update</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

</main>

<script>
    // Sidebar + Dark mode + Section toggle
    function openSidebar() { document.getElementById('sidebar').classList.add('open'); document.getElementById('sidebarOverlay').style.display = 'block'; }
    function closeSidebar() { document.getElementById('sidebar').classList.remove('open'); document.getElementById('sidebarOverlay').style.display = 'none'; }

    function toggleDarkMode() {
        document.body.classList.toggle('dark');
        const isDark = document.body.classList.contains('dark');
        document.getElementById('themeIcon').textContent = isDark ? 'â˜€ï¸' : 'ðŸŒ™';
        localStorage.setItem('auditor_theme', isDark ? 'dark' : 'light');

        // You might want to update charts here if they need different colors for dark mode
        // Or send this preference to the server via a simple fetch call
    }

    // Apply theme on load
    if (localStorage.getItem('auditor_theme') === 'dark' || (!localStorage.getItem('auditor_theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.body.classList.add('dark');
        document.getElementById('themeIcon').textContent = 'â˜€ï¸';
    }

    function showSection(id) {
        ['dashboard', 'cve', 'product', 'profile'].forEach(s => {
            document.getElementById(s + 'Section').classList.add('d-none');
            document.getElementById('side-' + s).classList.remove('active');
        });
        document.getElementById(id + 'Section').classList.remove('d-none');
        document.getElementById('side-' + id).classList.add('active');
        closeSidebar();
    }

    //  CVE Filters
    // âœ… ENHANCED VERSION
    function filterCves() {
        const search = document.getElementById("searchCveInput").value.toLowerCase();
        const sev = document.getElementById("severityFilter").value;
        const stat = document.getElementById("statusFilter").value;
        const from = document.getElementById("fromDate").value;
        const to = document.getElementById("toDate").value;
        const rows = document.querySelectorAll("#cveTable tbody tr");

        rows.forEach(r => {
            // Target specific cells for search
            const cveId = r.cells[0].innerText.toLowerCase();
            const pkg = r.cells[1].innerText.toLowerCase();
            const desc = r.cells[2].innerText.toLowerCase();
            const searchText = cveId + " " + pkg + " " + desc;

            // Target specific cells for filters
            const rowSeverity = r.cells[3].innerText.trim().toUpperCase();
            const rowStatus = r.cells[4].innerText.trim().toUpperCase();
            const date = r.cells[8].innerText.trim(); // *** CELL INDEX UPDATED TO 8 ***

            let ok = true;

            if (search && !searchText.includes(search)) ok = false;
            if (sev && rowSeverity !== sev.toUpperCase()) ok = false;
            if (stat && rowStatus !== stat.toUpperCase()) ok = false;
            if (from && date < from) ok = false;
            if (to && date > to) ok = false;

            r.style.display = ok ? "" : "none";
        });
    }


    function resetCveFilters() {
        document.getElementById("searchCveInput").value = "";
        document.getElementById("severityFilter").value = "";
        document.getElementById("statusFilter").value = "";
        document.getElementById("fromDate").value = "";
        document.getElementById("toDate").value = "";
        filterCves();
    }

    //  Product Filters
    // âœ… FIXED PRODUCT FILTER
    function filterProducts() {
        const search = document.getElementById("searchProductInput").value.toLowerCase();
        const stat = document.getElementById("productStatusFilter").value;
        const rows = document.querySelectorAll("#productTable tbody tr");

        rows.forEach(r => {
            const t = r.innerText.toLowerCase();
            const rowStatus = r.cells[3].innerText.trim().toUpperCase();

            let ok = true;
            if (search && !t.includes(search)) ok = false;
            if (stat && rowStatus !== stat.toUpperCase()) ok = false;  // âœ… Exact match

            r.style.display = ok ? "" : "none";
        });
    }

    function resetProductFilters() {
        document.getElementById("searchProductInput").value = "";
        document.getElementById("productStatusFilter").value = "";
        filterProducts();
    }

    // Charts
    document.addEventListener('DOMContentLoaded', () => {
        // Helper function to parse data attributes
        const parseChartData = (element, dataName) => {
            try {
                // Thymeleaf serializes arrays as [item1, item2], which is valid JSON
                return JSON.parse(element.dataset[dataName] || '[]');
            } catch (e) {
                console.error(`Error parsing chart data: ${dataName}`, e);
                return [];
            }
        };

        // Severity Chart
        const sevChartEl = document.getElementById('severityChart');
        const sevLabels = parseChartData(sevChartEl, 'labels').length ? parseChartData(sevChartEl, 'labels') : ['LOW', 'MEDIUM', 'HIGH', 'CRITICAL'];
        const sevValues = parseChartData(sevChartEl, 'values').length ? parseChartData(sevChartEl, 'values') : [0, 0, 0, 0];

        if (sevChartEl) {
            new Chart(sevChartEl, {
                type: 'doughnut',
                data: {
                    labels: sevLabels,
                    datasets: [{ data: sevValues, backgroundColor: ['#27ae60', '#f39c12', '#e67e22', '#e74c3c'] }]
                },
                options: { plugins: { legend: { position: 'bottom' } } }
            });
        }

        // Status Chart
        const statChartEl = document.getElementById('statusChart');
        const statLabels = parseChartData(statChartEl, 'labels').length ? parseChartData(statChartEl, 'labels') : ['ACTIVE', 'INACTIVE'];
        const statValues = parseChartData(statChartEl, 'values').length ? parseChartData(statChartEl, 'values') : [0, 0];

        if (statChartEl) {
            new Chart(statChartEl, {
                type: 'pie',
                data: {
                    labels: statLabels,
                    datasets: [{ data: statValues, backgroundColor: ['#27ae60', '#e74c3c'] }]
                },
                options: { plugins: { legend: { position: 'bottom' } } }
            });
        }

        // Product Chart
        const prodChartEl = document.getElementById('productChart');
        const prodLabels = parseChartData(prodChartEl, 'labels').length ? parseChartData(prodChartEl, 'labels') : ['PRD-001', 'PRD-002'];
        const prodValues = parseChartData(prodChartEl, 'values').length ? parseChartData(prodChartEl, 'values') : [0, 0];

        if (prodChartEl) {
            new Chart(prodChartEl, {
                type: 'bar',
                data: {
                    labels: prodLabels,
                    datasets: [{ label: 'CVEs', data: prodValues, backgroundColor: '#007bff' }]
                },
                options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
            });
        }
    });
</script>

</body>
</html>
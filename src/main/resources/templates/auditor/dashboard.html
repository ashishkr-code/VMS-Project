<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Auditor Dashboard</title>

    <!-- Dependencies -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css" rel="stylesheet">

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>

    <style>
        body {
          display: flex;
          background: #f8f9fa;
          color: #212529;
          min-height: 100vh;
        }
        .sidebar {
          width: 240px;
          background: #fff;
          height: 100vh;
          position: fixed;
          padding-top: 20px;
          box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        .sidebar a {
          display: block;
          color: #212529;
          padding: 12px 20px;
          border-radius: 8px;
          margin: 5px 10px;
          text-decoration: none;
        }
        .sidebar a.active, .sidebar a:hover {
          background: #007bff;
          color: #fff;
        }
        .main { flex-grow: 1; margin-left: 240px; padding: 30px; }
        canvas { max-height: 220px !important; }
    </style>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar">
    <h4 class="text-center text-primary mb-4"><i class="fa-solid fa-user-shield"></i> Auditor</h4>
    <a href="#" class="active" data-page="dashboard"><i class="fa-solid fa-gauge"></i> Dashboard</a>
    <a href="#" data-page="cves"><i class="fa-solid fa-bug"></i> CVEs</a>
    <a href="#" data-page="products"><i class="fa-solid fa-box"></i> Products</a>
    <a href="#" data-page="profile"><i class="fa-solid fa-user"></i> Profile</a>
</div>

<!-- Main -->
<div class="main">
    <div class="top-bar d-flex justify-content-between align-items-center mb-4">
        <h2 id="pageTitle">Dashboard Overview</h2>
    </div>
    <div id="contentArea"></div>
</div>

<!-- Modal -->
<div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    const cves = /*[[${cves}]]*/ [];
    const products = /*[[${products}]]*/ [];
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    $(function(){
      const modal = new bootstrap.Modal(document.getElementById("detailModal"));
      loadPage("dashboard");

      $(".sidebar a[data-page]").click(function(e){
        e.preventDefault();
        $(".sidebar a").removeClass("active");
        $(this).addClass("active");
        const page = $(this).data("page");
        $("#pageTitle").text(page.charAt(0).toUpperCase() + page.slice(1));
        loadPage(page);
      });

      function loadPage(page){
        $("#contentArea").html("<div class='text-center p-5'><div class='spinner-border text-primary'></div></div>");
        setTimeout(()=>{
          if(page==="dashboard") renderDashboard();
          else if(page==="cves") renderCves();
          else if(page==="products") renderProducts();
          else renderProfile();
        },200);
      }

      // üìä Dashboard
      function renderDashboard(){
        $("#contentArea").html(`
          <div class="row g-4 mb-4">
            <div class="col-md-4"><div class="card p-3 text-center"><h6>Total CVEs</h6><h3>${cves.length}</h3></div></div>
            <div class="col-md-4"><div class="card p-3 text-center"><h6>Total Products</h6><h3>${products.length}</h3></div></div>
            <div class="col-md-4"><div class="card p-3 text-center"><h6>Active CVEs</h6><h3>${cves.filter(c=>c.status==='Active').length}</h3></div></div>
          </div>
          <div class="row g-4">
            <div class="col-md-6"><div class="card p-3"><canvas id="severityChart"></canvas></div></div>
            <div class="col-md-6"><div class="card p-3"><canvas id="statusChart"></canvas></div></div>
          </div>
        `);

        const severityCounts = {};
        const statusCounts = {};
        cves.forEach(c => {
          severityCounts[c.severity] = (severityCounts[c.severity]||0)+1;
          statusCounts[c.status] = (statusCounts[c.status]||0)+1;
        });

        new Chart(document.getElementById("severityChart"), {
          type: "bar",
          data: {
            labels: Object.keys(severityCounts),
            datasets: [{ label: "Severity Distribution", data: Object.values(severityCounts) }]
          }
        });
        new Chart(document.getElementById("statusChart"), {
          type: "doughnut",
          data: {
            labels: Object.keys(statusCounts),
            datasets: [{ label: "CVE Status", data: Object.values(statusCounts) }]
          }
        });
      }

      // üêû CVEs
      function renderCves(){
        $("#contentArea").html(`
          <div class="card p-3">
            <div class="filters mb-2 d-flex gap-2">
              <select id="filterSeverity"><option value="">All Severities</option><option>Critical</option><option>High</option><option>Medium</option><option>Low</option></select>
              <select id="filterStatus"><option value="">All Statuses</option><option>Active</option><option>Inactive</option></select>
            </div>
            <table id="cveTable" class="table table-striped">
              <thead><tr><th>CVE ID</th><th>Package</th><th>Description</th><th>Severity</th><th>Status</th><th>Version</th></tr></thead>
              <tbody>
                ${cves.map(c=>{
                  let version = (typeof c.version === 'object') ? (c.version?.version || JSON.stringify(c.version)) : c.version;
                  return `<tr data-id="${c.cveId}">
                    <td>${c.cveId}</td><td>${c.packageName}</td><td>${c.description}</td>
                    <td>${c.severity}</td><td>${c.status}</td><td>${version || '-'}</td>
                  </tr>`;
                }).join("")}
              </tbody>
            </table>
          </div>
        `);

        const table = $("#cveTable").DataTable({
          dom: 'Bfrtip',
          buttons: ['copy', 'csv', 'excel', 'pdf', 'print'],
          pageLength: 7
        });

        $("#filterSeverity, #filterStatus").on("change",function(){
          const sev = $("#filterSeverity").val().toLowerCase();
          const stat = $("#filterStatus").val().toLowerCase();
          table.rows().every(function(){
            const data = this.data();
            const show = (!sev || data[3].toLowerCase().includes(sev)) && (!stat || data[4].toLowerCase().includes(stat));
            $(this.node()).toggle(show);
          });
        });

        $("#cveTable tbody").on("click","tr",function(){
          const id = $(this).data("id");
          const c = cves.find(x=>x.cveId===id);
          $("#modalTitle").text("CVE Details - "+c.cveId);
          $("#modalBody").html(`
            <p><strong>Package:</strong> ${c.packageName}</p>
            <p><strong>Description:</strong> ${c.description}</p>
            <p><strong>Severity:</strong> ${c.severity}</p>
            <p><strong>Status:</strong> ${c.status}</p>
            <p><strong>Version:</strong> ${(typeof c.version === 'object') ? (c.version?.version || JSON.stringify(c.version)) : c.version}</p>
          `);
          modal.show();
        });
      }

      // üì¶ Products
      function renderProducts(){
        $("#contentArea").html(`
          <div class="card p-3">
            <table id="productTable" class="table table-hover">
              <thead><tr><th>Product ID</th><th>Name</th><th>Model</th><th>Status</th><th>Published</th></tr></thead>
              <tbody>
                ${products.map(p=>`
                  <tr data-id="${p.productId}">
                    <td>${p.productId}</td><td>${p.name}</td><td>${p.modelno}</td>
                    <td>${p.status}</td><td>${p.publishAt?p.publishAt:'-'}</td>
                  </tr>`).join("")}
              </tbody>
            </table>
          </div>
        `);

        $("#productTable").DataTable({
          dom: 'Bfrtip',
          buttons: ['csv','excel','pdf','print'],
          pageLength: 7
        });

        $("#productTable tbody tr").click(function(){
          const id=$(this).data("id");
          const p=products.find(x=>x.productId===id);
          $("#modalTitle").text("Product Details - "+p.name);
          $("#modalBody").html(`
            <p><strong>Model No:</strong> ${p.modelno}</p>
            <p><strong>Status:</strong> ${p.status}</p>
            <p><strong>Published:</strong> ${p.publishAt?p.publishAt:'-'}</p>
          `);
          modal.show();
        });
      }

      // üë§ Profile
      function renderProfile(){
        $("#contentArea").html(`
          <div class="card p-4 mx-auto" style="max-width:500px;">
            <div class="text-center">
              <img src="https://i.pravatar.cc/120?img=8" class="rounded-circle mb-3">
              <h4>Ravi Sharma</h4>
              <p class="text-muted">Security Auditor</p>
            </div>
            <button class="btn btn-primary w-100">Edit Profile</button>
          </div>
        `);
      }
    });
</script>
</body>
</html>
